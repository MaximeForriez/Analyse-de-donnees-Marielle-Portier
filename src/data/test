# -*- coding: utf-8 -*-

import pandas as pd
import matplotlib.pyplot as plt
import os

# Vérifie que le fichier existe avant de le lire
chemin_fichier = os.path.abspath(os.path.join(os.path.dirname(__file__), "resultats-elections-presidentielles-2022-1er-tour.csv"))

if not os.path.exists(chemin_fichier):
    print(f"⚠️ Erreur : le fichier {chemin_fichier} est introuvable.")
else:
    print("✅ Fichier trouvé, lecture en cours...\n")

    # Lecture du CSV avec Pandas en utilisant with
    with open(chemin_fichier, encoding="utf-8") as fichier:
        contenu = pd.read_csv(fichier)

    # Affiche le contenu complet avec DataFrame
    print("\n=== Contenu complet du DataFrame ===")
    print(contenu)

    # Affiche les 5 premières lignes pour vérifier la lecture
    print("=== Aperçu du fichier ===")
    print(contenu.head())

    # --- Nombre de lignes et colonnes ---
    nb_lignes = len(contenu)
    nb_colonnes = len(contenu.columns)

    print(f"\nNombre de lignes : {nb_lignes}")
    print(f"Nombre de colonnes : {nb_colonnes}")

    # --- Types des colonnes ---
    print("\n=== Types détectés par pandas ===")
    print(contenu.dtypes)

    # --- Conversion des types pandas vers types simples ---
    def map_dtype(dtype):
        dtype_str = str(dtype)
        if "int" in dtype_str:
            return "int"
        elif "float" in dtype_str:
            return "float"
        elif "bool" in dtype_str:
            return "bool"
        else:
            return "str"

    types_simple = {col: map_dtype(typ) for col, typ in contenu.dtypes.items()}

    print("\n=== Types simplifiés ===")
    for col, typ in types_simple.items():
        print(f"{col} : {typ}")

    # --- Affichage des noms des colonnes ---
    print("\n=== Noms des colonnes ===")
    print(contenu.columns.tolist())

    # --- Sélection et affichage du nombre d'inscrits ---
    print("\n=== Nombre total d'inscrits ===")
    nombre_inscrits = contenu['Inscrits'].sum()
    print(f"Nombre total d'inscrits : {nombre_inscrits:,}")

    # --- Calcul des effectifs par colonne pour les données quantitatives ---
    print("\n=== Somme des effectifs par colonne (données quantitatives uniquement) ===")
    effectifs = []
    for colonne, type_var in types_simple.items():
        if type_var in ['int', 'float']:  # On ne somme que les données numériques
            somme = contenu[colonne].sum()
            effectifs.append((colonne, somme))
            print(f"{colonne}: {somme:,.2f}")

# --- Diagrammes en barres des inscrits et votants par département ---
    print("\n=== Création des diagrammes en barres ===")
    for index, row in contenu.iterrows():
        plt.figure(figsize=(10, 6))
        plt.bar(['Inscrits', 'Votants'], [row['Inscrits'], row['Votants']])
        plt.title(f"Inscrits et votants - {row['Libellé du département']}")
        plt.ylabel('Nombre de personnes')
        plt.grid(True, alpha=0.3)
        
        # Sauvegarde du diagramme en barres
        filename = f"barplot_{row['Code du département']}.png"
        plt.savefig(os.path.join(os.path.dirname(__file__), "images", "barplots", filename))
        plt.close()

    # --- Diagrammes circulaires pour chaque département ---
    print("\n=== Création des diagrammes circulaires ===")
    for index, row in contenu.iterrows():
        plt.figure(figsize=(10, 8))
        labels = ['Blancs', 'Nuls', 'Exprimés', 'Abstentions']
        values = [row['Blancs'], row['Nuls'], row['Exprimés'], row['Abstentions']]
        plt.pie(values, labels=labels, autopct='%1.1f%%')
        plt.title(f"Répartition des votes - {row['Libellé du département']}")
        
        # Sauvegarde du diagramme circulaire
        filename = f"piechart_{row['Code du département']}.png"
        plt.savefig(os.path.join(os.path.dirname(__file__), "images", "piecharts", filename))
        plt.close()

    # --- Histogramme de la distribution des inscrits ---
    print("\n=== Création de l'histogramme des inscrits ===")
    plt.figure(figsize=(12, 6))
    plt.hist(contenu['Inscrits'], bins=30, edgecolor='black')
    plt.title("Distribution du nombre d'inscrits par département")
    plt.xlabel("Nombre d'inscrits")
    plt.ylabel("Nombre de départements")
    plt.grid(True, alpha=0.3)
    
    # Sauvegarde de l'histogramme
    plt.savefig(os.path.join(os.path.dirname(__file__), "images", "histogram_inscrits.png"))
    plt.close()

    print("\n✅ Toutes les visualisations ont été créées avec succès !")

# Fin du script